<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Make User Admin - Rolling Translations</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f9fafb;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Make User Admin</h1>
        <p>Grant admin privileges to users via Firestore role assignment.</p>

        <div class="form-group">
            <label for="targetEmail">Email of user to make admin:</label>
            <input type="email" id="targetEmail" placeholder="user@example.com" required>
        </div>

        <button id="makeAdminBtn" class="btn">Set Admin Role</button>

        <div id="status"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const targetEmailInput = document.getElementById('targetEmail');
        const makeAdminBtn = document.getElementById('makeAdminBtn');
        const statusDiv = document.getElementById('status');

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = type;
            statusDiv.style.display = 'block';
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                showStatus('Please sign in to use this tool.', 'error');
                makeAdminBtn.disabled = true;
                return;
            }

            // Check if current user is admin
            try {
                const userDoc = await getDocs(query(collection(db, 'users'), where('__name__', '==', user.uid)));
                const isCurrentUserAdmin = userDoc.docs.length > 0 && userDoc.docs[0].data().role === 'admin';

                if (!isCurrentUserAdmin) {
                    showStatus('Access denied. Only existing admins can create new admins.', 'error');
                    makeAdminBtn.disabled = true;
                } else {
                    showStatus(`Signed in as admin: ${user.email}`, 'success');
                }
            } catch (error) {
                showStatus('Error checking admin status. Proceeding with caution.', 'info');
            }
        });

        makeAdminBtn.addEventListener('click', async () => {
            const targetEmail = targetEmailInput.value.trim();

            if (!targetEmail) {
                showStatus('Please enter an email address.', 'error');
                return;
            }

            try {
                makeAdminBtn.disabled = true;
                showStatus('Setting admin role...', 'info');

                // Find user by email in Auth users (we need their UID)
                // Since we can't query Auth users directly from client, we'll use a workaround
                // For now, we'll ask them to provide the UID or create the user document with email as key

                // Alternative: Create admin role by email
                const userQuery = query(collection(db, 'users'), where('email', '==', targetEmail));
                const userSnapshot = await getDocs(userQuery);

                let targetUid;
                if (!userSnapshot.empty) {
                    // User already exists, get their UID
                    targetUid = userSnapshot.docs[0].id;
                } else {
                    // For new users, we'll need their UID - show instructions
                    showStatus(`User ${targetEmail} not found in database. They need to sign in first to create their account.`, 'error');
                    makeAdminBtn.disabled = false;
                    return;
                }

                // Set admin role in Firestore
                await setDoc(doc(db, 'users', targetUid), {
                    role: 'admin',
                    email: targetEmail,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                showStatus(`Successfully granted admin role to ${targetEmail}`, 'success');
                targetEmailInput.value = '';

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Error making user admin:', error);
            } finally {
                makeAdminBtn.disabled = false;
            }
        });
    </script>
</body>
</html>