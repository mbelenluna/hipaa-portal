<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rolling Translations Client Portal</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        /* ---- Files UI ---- */
        .dropzone {
            border: 2px dashed #9bb4ff;
            border-radius: 10px;
            padding: 18px;
            text-align: center;
            background: #f7faff;
            transition: background .15s, border-color .15s;
            cursor: pointer
        }

        .dropzone.dragover {
            background: #eef4ff;
            border-color: #5b82ff
        }

        .files-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px
        }

        .file-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 14px;
            background: #fff;
            font-size: 14px
        }

        .file-remove {
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            line-height: 1;
            color: #c00
        }

        .hint {
            font-size: 13px;
            color: #666;
            margin-top: 6px
        }

        .rush-row {
            display: grid;
            grid-template-columns: 20px 1fr;
            align-items: center;
            column-gap: 10px;
            margin: 12px 0 8px;
        }

        .rush-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
        }

        .rush-label {
            font-weight: 600;
            line-height: 1.2;
            margin: 0;
        }

        #requestsTable tbody tr.rush {
            background: #fff1f2;
        }
    </style>
</head>

<body>
    <div class="container">
        <img src="images/logo.png" alt="Rolling Translations Logo" class="logo" />
        <h1>Submit Translation Request</h1>
        <p class="description">
            Use this secure form to upload documents for translation. Rolling Translations provides HIPAA-compliant
            services with fast turnaround times, including 24/7 support for urgent medical content.
        </p>

        <form id="projectRequestForm">
            <label for="sourceLang">Source Language (*)</label>
            <p class="instruction">To select multiple languages, hold your ctrl (Control) key while selecting all
                languages.</p>
            <select class="languages-box" id="sourceLang" name="sourceLang" multiple required>
                <option value="">-- Select --</option>
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="id">Bahasa Indonesian</option>
                <option value="ms">Bahasa Malaysian</option>
                <option value="bn">Bengali</option>
                <option value="my">Burmese</option>
                <option value="km">Cambodian</option>
                <option value="ca">Catalan</option>
                <option value="cs">Czech</option>
                <option value="dr">Dari</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="fa">Farsi</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="lo">Lao</option>
                <option value="pt">Portuguese</option>
                <option value="pa">Punjabi</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="szh">Simplified Chinese</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="th">Thai</option>
                <option value="tzh">Traditional Chinese</option>
                <option value="tr">Turkish</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
            </select>

            <label for="targetLang">Target Language (*)</label>
            <p class="instruction">To select multiple languages, hold your ctrl (Control) key while selecting all
                languages.</p>
            <select class="languages-box" id="targetLang" name="targetLang" multiple required>
                <option value="">-- Select --</option>
                <option value="sq">Albanian</option>
                <option value="ar">Arabic</option>
                <option value="hy">Armenian</option>
                <option value="id">Bahasa Indonesian</option>
                <option value="ms">Bahasa Malaysian</option>
                <option value="bn">Bengali</option>
                <option value="my">Burmese</option>
                <option value="km">Cambodian</option>
                <option value="ca">Catalan</option>
                <option value="cs">Czech</option>
                <option value="dr">Dari</option>
                <option value="nl">Dutch</option>
                <option value="en">English</option>
                <option value="fa">Farsi</option>
                <option value="fi">Finnish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="el">Greek</option>
                <option value="he">Hebrew</option>
                <option value="hi">Hindi</option>
                <option value="ja">Japanese</option>
                <option value="ko">Korean</option>
                <option value="lo">Lao</option>
                <option value="pt">Portuguese</option>
                <option value="pa">Punjabi</option>
                <option value="ro">Romanian</option>
                <option value="ru">Russian</option>
                <option value="szh">Simplified Chinese</option>
                <option value="es">Spanish</option>
                <option value="sw">Swahili</option>
                <option value="sv">Swedish</option>
                <option value="tl">Tagalog</option>
                <option value="th">Thai</option>
                <option value="tzh">Traditional Chinese</option>
                <option value="tr">Turkish</option>
                <option value="ur">Urdu</option>
                <option value="vi">Vietnamese</option>
            </select>

            <label>Upload Files (*)</label>
            <div id="dropzone" class="dropzone">
                <strong>Drag & drop</strong> files here or <u>click to select</u>.
                <div class="hint">You can add files from different folders. They will appear below.</div>
                <input type="file" id="file" name="file" multiple style="display:none;" />
            </div>
            <div id="filesList" class="files-list"></div>

            <div class="rush-row">
                <input type="checkbox" id="rush" name="rush" />
                <label for="rush" class="rush-label">Rush (expedite this project)</label>
            </div>

            <label for="notes">Additional Notes</label>
            <textarea id="notes" name="notes" rows="4"></textarea>

            <p class="left-aligned">(*) Required fields.</p>

            <button type="submit" id="submitBtn">Send Request</button>
        </form>

        <p id="loadingMsg" style="display:none; text-align:center;">‚è≥ Please wait, your request is being processed...
        </p>
        <p id="confirmationMsg" style="display:none; text-align:center; color:green; font-weight:bold;">‚úÖ Project
            request sent! You will be redirected shortly.</p>

        <button type="button" id="backToDashboardBtn">Back to Dashboard</button>
        <script>document.getElementById('backToDashboardBtn').addEventListener('click', () => { window.location.href = 'dashboard.html'; });</script>

        <button id="logoutBtn">Log out</button>
    </div>

    <iframe name="hiddenFrame" style="display:none;"></iframe>

    <form id="spreadsheetForm" method="POST" target="hiddenFrame" style="display:none;"
        action="https://script.google.com/macros/s/AKfycbzlbLHJLnpUWB_YTIwD7bIiAs2AZh_csQvXECSABVtGFOT1r6CDVjQbvf4qJWclN0r6Rg/exec">
        <input name="fullname" id="fullnameField" />
        <input name="email" id="emailField" />
        <input name="phonenumber" id="phoneField" />
        <input name="sourceLang" id="sourceLangField" />
        <input name="targetLang" id="targetLangField" />
        <input name="notes" id="notesField" />
        <input name="fileName" id="fileNameField" />
        <input name="projectId" id="projectIdField" />
        <input name="rush" id="rushField" />
    </form>

    <script type="module">
        // --------------------------
        // Global error handlers
        // --------------------------
        window.addEventListener('error', (e) => {
            console.error('üî• window.error:', e.message, { filename: e.filename, lineno: e.lineno, colno: e.colno, error: e.error });
        });
        window.addEventListener('unhandledrejection', (e) => {
            console.error('üí• unhandledrejection:', e.reason);
        });

        import { initializeApp, setLogLevel as setCoreLogLevel } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";
        import { getStorage, ref, uploadBytes, connectStorageEmulator } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-storage.js";
        import { getFirestore, addDoc, collection, serverTimestamp, doc, getDoc, updateDoc, setDoc, setLogLevel as setFirestoreLogLevel, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";
        import { getFunctions, connectFunctionsEmulator } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-functions.js";

        // ---- Debug controls ----
        const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
        if (DEBUG) {
            setCoreLogLevel('debug');
            setFirestoreLogLevel('debug');
            console.info('üõ† Debug mode ON (add ?debug=0 to disable)');
        }

        // ---- Firebase config ----
        const firebaseConfig = {
            apiKey: "AIzaSyBYjq_CaTEfFhfTChfJ6SnXSbgIzbbRHHc",
            authDomain: "rollingtranslationsportal.firebaseapp.com",
            projectId: "rollingtranslationsportal",
            storageBucket: "rollingtranslationsportal.firebasestorage.app",
            messagingSenderId: "492156326175",
            appId: "1:492156326175:web:14175badae2bbaada0e02a"
        };

        console.groupCollapsed('‚öôÔ∏è Firebase init');
        console.log('Origin:', location.origin);
        console.log('Project:', firebaseConfig.projectId);
        console.log('Auth domain:', firebaseConfig.authDomain);
        console.log('Storage bucket (config):', firebaseConfig.storageBucket);
        console.groupEnd();

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app, "gs://rollingtranslationsportal.firebasestorage.app");
        const functions = getFunctions(app, "us-central1");

        // Emulator connections disabled for production testing
        // if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        //     connectFirestoreEmulator(db, 'localhost', 8080);
        //     connectFunctionsEmulator(functions, 'localhost', 5001);
        //     connectStorageEmulator(storage, 'localhost', 9199);
        //     connectAuthEmulator(auth, 'http://localhost:9099');
        //     console.log('Connected to Firebase emulators');
        // }

        console.log("Storage root:", ref(storage).toString());

        let clientFullName = "";
        let clientOrg = "";
        let clientPhone = "";

        // --------------------------
        // Helpers
        // --------------------------
        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        

        async function ensureOwnershipVisible(docRef, expectedUid, retries = 5) {
            if (retries === 0) {
                console.warn("‚ö†Ô∏è Max retries reached. Document not visible or uid mismatch.");
                return false;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().ownerUid === expectedUid) {
                    console.log(`‚úÖ Document is visible after ${5 - retries} attempt(s).`);
                    return true;
                } else {
                    console.warn(`‚è≥ Document not visible or uid mismatch. Retrying... (Attempts left: ${retries})`);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Wait for 500ms
                    return await ensureOwnershipVisible(docRef, expectedUid, retries - 1);
                }
            } catch (error) {
                console.error("‚ùå Error while checking Firestore document:", error);
                return false;
            }
        }

        async function uploadWithRetry(fileRef, file, attempts = 3) {
            let lastErr;
            for (let i = 1; i <= attempts; i++) {
                try {
                    const t0 = performance.now();
                    const res = await uploadBytes(fileRef, file);
                    console.log(`Upload OK (attempt ${i}):`, { ms: Math.round(performance.now() - t0) });
                    return res;
                } catch (err) {
                    lastErr = err;
                    console.error(`Upload attempt ${i} FAILED:`, { code: err.code, message: err.message, customData: err.customData });
                    if (err.code !== 'storage/unauthorized' && err.code !== 'storage/retry-limit-exceeded') break;
                    await sleep(400);
                }
            }
            throw lastErr;
        }

        // --------------------------
        // Auth session
        // --------------------------
        onAuthStateChanged(auth, async (user) => {
            console.groupCollapsed('üë§ Auth state changed');
            if (!user) {
                console.warn('Not signed in, redirecting to index.html');
                console.groupEnd();
                window.location.href = "index.html";
                return;
            }
            console.log('User:', { uid: user.uid, email: user.email, displayName: user.displayName });
            try {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    clientFullName = userData.fullName || user.displayName || '';
                    clientOrg = userData.org || '';
                    clientPhone = userData.phone || "";
                    console.log('Loaded user profile:', { clientFullName, clientOrg });
                } else {
                    console.log('No user profile doc; using auth displayName only.');
                    clientFullName = user.displayName || '';
                }
            } catch (e) {
                console.error('Failed to fetch user profile:', e);
            }
            console.groupEnd();

            if (DEBUG) await debugSmokeTest();
        });

        // Logout
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
            logoutBtn.addEventListener("click", () => {
                signOut(auth).then(() => { window.location.href = "index.html"; });
            });
        }

        // ---------- Multiple files handling ----------
        const dropzone = document.getElementById("dropzone");
        const fileInput = document.getElementById("file");
        const filesListEl = document.getElementById("filesList");

        let selectedFiles = []; // array of File

        function filesAreSame(a, b) { return a.name === b.name && a.size === b.size && a.lastModified === b.lastModified; }
        function addFiles(files) { for (const f of files) { if (!selectedFiles.some(sf => filesAreSame(sf, f))) selectedFiles.push(f); } renderFiles(); }
        function removeFileAt(index) { selectedFiles.splice(index, 1); renderFiles(); }
        function renderFiles() {
            filesListEl.innerHTML = "";
            if (!selectedFiles.length) return;
            selectedFiles.forEach((f, idx) => {
                const chip = document.createElement("div");
                chip.className = "file-chip";
                chip.innerHTML = `<span title="${f.name}">${f.name}</span><button type="button" class="file-remove" aria-label="Remove file">‚úï</button>`;
                chip.querySelector(".file-remove").addEventListener("click", () => removeFileAt(idx));
                filesListEl.appendChild(chip);
            });
        }

        dropzone.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => { if (e.target.files?.length) addFiles(e.target.files); fileInput.value = ""; });

        ["dragenter", "dragover"].forEach(evt => { dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add("dragover"); }); });
        ["dragleave", "drop"].forEach(evt => { dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("dragover"); }); });
        dropzone.addEventListener("drop", (e) => { const dtFiles = e.dataTransfer?.files; if (dtFiles && dtFiles.length) addFiles(dtFiles); });

        // Helpers
        const form = document.getElementById("projectRequestForm");
        const submitBtn = document.getElementById("submitBtn");
        const loadingMsg = document.getElementById("loadingMsg");
        const confirmationMsg = document.getElementById("confirmationMsg");
        const getSelectedValues = (sel) => Array.from(sel.selectedOptions).map(o => o.value);

        function buildProjectId({ sourceLang, targetLang, firstFileName, date = new Date() }) {
            const lettersOnly = (firstFileName || "").replace(/[^A-Za-z]/g, "").slice(0, 10);
            const MM = String(date.getMonth() + 1).padStart(2, "0");
            const DD = String(date.getDate()).padStart(2, "0");
            const YY = String(date.getFullYear()).slice(-2);
            const HH = String(date.getHours()).padStart(2, "0");
            const mm = String(date.getMinutes()).padStart(2, "0");
            const src = (Array.isArray(sourceLang) ? sourceLang.join("") : sourceLang || "").replace(/[^A-Za-z]/g, "");
            const tgt = (Array.isArray(targetLang) ? targetLang.join("") : targetLang || "").replace(/[^A-Za-z]/g, "");
            return `${src}${tgt}${lettersOnly}${MM}${DD}${YY}${HH}${mm}`;
        }

        function explainFirestoreError(err) {
            const code = err?.code || '';
            switch (code) {
                case 'permission-denied': return 'Rules blocked the write. Check Auth sign-in + rule conditions (e.g., ownerUid match).';
                case 'unauthenticated': return 'Not signed in. Make sure mbelenluna.github.io is in Auth ‚Üí Authorized domains.';
                case 'failed-precondition': return 'Precondition failed. Possibly App Check enforcement or DB not initialized.';
                case 'invalid-argument': return 'Invalid field value (e.g., undefined). Verify payload fields.';
                case 'unavailable': return 'Service unavailable / network hiccup. Retry.';
                default: return 'See console for details.';
            }
        }

        async function debugSmokeTest() {
            console.groupCollapsed('üö¨ Firestore smoke test');
            try {
                const t0 = performance.now();
                const r = await addDoc(collection(db, "z_debug"), { ok: true, t: serverTimestamp(), origin: location.origin });
                const t1 = performance.now();
                console.log('z_debug write OK:', r.id, `(${Math.round(t1 - t0)} ms)`);
            } catch (error) {
                console.error('z_debug write FAILED:', { code: error.code, message: error.message, customData: error.customData });
                console.warn('Hint:', explainFirestoreError(error));
            }
            console.groupEnd();
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const sourceLangSelect = document.getElementById("sourceLang");
            const targetLangSelect = document.getElementById("targetLang");
            const notes = document.getElementById("notes").value;
            const rush = document.getElementById("rush").checked;

            const sourceLang = getSelectedValues(sourceLangSelect);
            const targetLang = getSelectedValues(targetLangSelect);

            if (!selectedFiles.length) {
                alert("Please attach at least one file.");
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = "Sending...";
            loadingMsg.style.display = "block";

            console.group('üì¶ Submit flow');
            try {
                const user = auth.currentUser;
                if (!user) {
                    throw new Error("Authentication error: user not signed in.");
                }
                console.log('Auth currentUser:', { uid: user.uid, email: user.email });
                const userEmail = user?.email || "";
                const fullName = clientFullName || user?.displayName || (userEmail.split("@")[0] ?? "");
                const phone = clientPhone || "";

                const projectId = buildProjectId({ sourceLang, targetLang, firstFileName: selectedFiles[0].name, date: new Date() });
                console.log('Computed projectId:', projectId);

                // 1) Create the Firestore document first.
                console.groupCollapsed('üìù setDoc(projectRequests)');
                const prColl = collection(db, "projectRequests");
                const docRef = doc(prColl);
                const payload = {
                    projectId,
                    rush,
                    sourceLang: sourceLang.join(", "),
                    targetLang: targetLang.join(", "),
                    notes,
                    files: [],
                    fullname: fullName,
                    email: userEmail,
                    phone,
                    status: "Uploading",
                    deliverables: [],
                    createdAt: serverTimestamp(),
                    ownerUid: user.uid,
                    docId: docRef.id
                };
                try {
                    const t0 = performance.now();
                    await setDoc(docRef, payload);
                    console.log('Doc created with ID:', docRef.id, `(${Math.round(performance.now() - t0)} ms)`);
                } catch (error) {
                    console.error('setDoc FAILED:', { code: error.code, message: error.message, customData: error.customData });
                    console.warn('Hint:', explainFirestoreError(error));
                    throw error;
                } finally {
                    console.groupEnd();
                }

                // 2) ENSURE ownership is visible to Storage rules before attempting upload.
                console.groupCollapsed('‚åõÔ∏è Ensuring document ownership is visible to Storage rules');
                const visible = await ensureOwnershipVisible(docRef, user.uid);
                console.groupEnd();

                // This is the CRITICAL change: it throws an error if the ownership check fails.
                if (!visible) {
                    console.error('‚ùå Final check failed: Ownership was not visible to Storage rules. Aborting upload.');
                    throw new Error('Project document could not be validated. Please try again.');
                }

                // 3) Upload all source files using the new docId.
                console.groupCollapsed('‚òÅÔ∏è Uploading files');
                const uploadedNames = [];
                await Promise.all(selectedFiles.map(async (file, idx) => {
                    const storagePath = `user_uploads/${auth.currentUser.uid}/${docRef.id}/${Date.now()}_${file.name}`;
                    console.groupCollapsed(`‚Ü• [${idx + 1}/${selectedFiles.length}] ${file.name}`);
                    console.log('Uploading to:', storagePath, 'size:', file.size, 'type:', file.type);
                    const fileRef = ref(storage, storagePath);
                    try {
                        await uploadWithRetry(fileRef, file, 3);
                        uploadedNames.push(file.name);
                    } catch (err) {
                        console.error('Upload FAILED for', file.name, err);
                        throw err;
                    } finally {
                        console.groupEnd();
                    }
                }));
                console.groupEnd();

                // 4) Final update: attach file names and mark Pending.
                console.groupCollapsed('‚úÖ Final updateDoc(files, status)');
                try {
                    await updateDoc(docRef, {
                        files: uploadedNames,
                        status: "Pending"
                    });
                    console.log('Final update OK:', uploadedNames);
                } catch (error) {
                    console.error('Final updateDoc FAILED:', error);
                }
                console.groupEnd();

                // 5) Send to Google Sheet.
                console.groupCollapsed('üì§ Submit to Google Sheet');
                document.getElementById("fullnameField").value = fullName;
                document.getElementById("emailField").value = userEmail;
                document.getElementById("phoneField").value = phone;
                document.getElementById("sourceLangField").value = sourceLang.join(", ");
                document.getElementById("targetLangField").value = targetLang.join(", ");
                document.getElementById("notesField").value = notes;
                document.getElementById("fileNameField").value = uploadedNames.join(", ");
                document.getElementById("projectIdField").value = projectId;
                document.getElementById("rushField").value = rush ? "Yes" : "No";
                document.getElementById("spreadsheetForm").submit();
                console.log('Posted to Apps Script endpoint.');
                console.groupEnd();

                // 6) Show confirmation & redirect.
                loadingMsg.style.display = "none";
                confirmationMsg.style.display = "block";
                form.style.display = "none";
                setTimeout(() => {
                    window.location.href = "dashboard.html";
                }, 3000);

            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.textContent = "Send Request";
                loadingMsg.style.display = "none";
                console.error('‚ùå Submit flow FAILED:', { code: error.code, message: error.message, customData: error.customData });
                alert(`‚ö†Ô∏è ${error.code || 'error'}: ${error.message}`);
            } finally {
                console.groupEnd();
            }
        });
    </script>
</body>

</html>